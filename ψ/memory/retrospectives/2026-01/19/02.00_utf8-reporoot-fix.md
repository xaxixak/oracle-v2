# Session Retrospective

**Date**: 2026-01-19 02:00 (GMT+7)
**Duration**: ~30 minutes (continued from previous session)
**Focus**: Fix UTF-8 encoding และ REPO_ROOT issues ใน Oracle

---

## Summary

แก้ปัญหา 2 อย่างหลัก: (1) UTF-8 encoding สำหรับภาษาไทยใน `/api/learn` endpoint (2) REPO_ROOT ที่ชี้ไป `~/.oracle-v2` แทน project directory ทำให้ learning files หายหลัง re-index

---

## What We Fixed

### 1. UTF-8 Encoding (handlers.ts)
- **ปัญหา**: ภาษาไทยถูกเขียนเป็น `??????` ในไฟล์
- **สาเหตุ**: `fs.writeFileSync` บน Windows ไม่ handle UTF-8 ถูกต้อง
- **แก้ไข**: เปลี่ยนเป็น `Bun.write(filePath, new TextEncoder().encode(frontmatter))`
- **Note**: curl บน Windows ก็มีปัญหากับ UTF-8 — ต้องใช้ file input (`-d @file.json`)

### 2. REPO_ROOT Auto-detection (db.ts)
- **ปัญหา**: Learning files ถูกเขียนไป `~/.oracle-v2/ψ/` แทน project directory
- **สาเหตุ**: `REPO_ROOT` defaults ไป `~/.oracle-v2` สำหรับ bunx installs
- **แก้ไข**: เพิ่ม `detectRepoRoot()` function ที่:
  1. Check `ORACLE_REPO_ROOT` env var ก่อน
  2. Detect จาก `__dirname` (ถ้ามี `ψ/` folder)
  3. Fallback ไป `~/.oracle-v2` สำหรับ bunx

### 3. Async/Await Fix (server.ts)
- **ปัญหา**: `handleLearn` เปลี่ยนเป็น async แต่ไม่ได้ await
- **แก้ไข**: เพิ่ม `await` ใน server route

### 4. Cleanup Misplaced Files
- ย้าย `2026-01-15_my-first-learning.md` จาก `~/.oracle-v2/ψ/` ไป project
- ลบ corrupted files ที่มี encoding เสีย

---

## Files Changed

```
src/server/handlers.ts  - UTF-8 encoding fix
src/server/db.ts        - REPO_ROOT auto-detection
src/server.ts           - await handleLearn()
ψ/memory/learnings/     - เพิ่ม my-first-learning.md
```

---

## AI Diary

Session นี้เป็นการ debug ที่ลึกลงไปเรื่อยๆ เริ่มจากเห็นว่า retrospective ใหม่แสดงภาษาไทยได้ แต่ learning เก่าเป็น `??????`

ตอนแรกคิดว่าปัญหาอยู่ที่การเขียนไฟล์ เลยเปลี่ยนจาก `fs.writeFileSync` เป็น `Bun.write` แต่ยังไม่หาย พอลองใช้ `TextEncoder` ก็ยังไม่ได้ — สุดท้ายพบว่าปัญหาอยู่ที่ **curl บน Windows** ไม่ส่ง UTF-8 ถูกต้องเมื่อใช้ `-d '...'` โดยตรง!

การค้นพบ REPO_ROOT issue น่าสนใจ — ไฟล์ถูกเขียนไปที่ถูกต้อง (`~/.oracle-v2/ψ/`) ตาม code logic แต่ผิดตาม intent เพราะ development ควรเขียนไป project directory การแก้ด้วย `detectRepoRoot()` ที่ check `ψ/` folder เป็น solution ที่ backward compatible กับ bunx installs

---

## Lessons Learned

- **Pattern**: Windows + UTF-8 + CLI = ต้องระวัง encoding ทุกจุด (file write, curl, terminal)
- **Pattern**: Default paths ที่เหมาะกับ production อาจไม่เหมาะกับ development
- **Discovery**: `Bun.write` + `TextEncoder` ทำงานถูกต้อง แต่ต้องให้ input เป็น UTF-8 ตั้งแต่แรก
- **Discovery**: curl `-d @file.json` ส่ง UTF-8 ได้ถูกต้อง แต่ `-d '...'` ไม่ได้

---

## Next Steps

- [ ] Commit fixes
- [ ] Test learning creation จาก frontend (ไม่มีปัญหา curl)
- [ ] Consider adding UTF-8 BOM สำหรับ Windows compatibility

---

*Debug session ที่ลึกลงไปหลายชั้น — แต่ได้ความรู้เยอะ*
